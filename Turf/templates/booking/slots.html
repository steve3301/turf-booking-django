{% extends "booking/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'booking/css/style.css' %}">

<div class="slots-wrapper">

  <div class="slots-top">
    <h1>{{ sport.name }}</h1>
    <p>Choose your time. Lock your game.</p>
  </div>

  <!-- DATE STRIP -->
  <div class="date-strip">
    {% for d in dates %}
      <a href="?date={{ d|date:'Y-m-d' }}"
         class="date-box {% if d == selected_date %}active{% endif %}">
        <strong>{{ d|date:"D" }}</strong>
        <span>{{ d|date:"d" }}</span>
        <small>{{ d|date:"M" }}</small>
      </a>
    {% endfor %}
  </div>

  <!-- FILTERS -->
  <div class="slot-filters">
    <button class="filter active" onclick="filterSlots('all', this)">All</button>
    <button class="filter" onclick="filterSlots('morning', this)">Morning</button>
    <button class="filter" onclick="filterSlots('afternoon', this)">Afternoon</button>
    <button class="filter" onclick="filterSlots('evening', this)">Evening</button>
  </div>

  <!-- SLOT GRID -->
  <div class="slots-grid">
    {% for slot in slots %}

      {% if slot.is_booked %}
        <div class="slot booked" data-hour="{{ slot.time.hour }}">
          <h4>{{ slot.display_time }}</h4>
          <span>Booked</span>
        </div>

      {% elif selected_date == today and slot.time.hour < current_hour %}
        <div class="slot expired" data-hour="{{ slot.time.hour }}">
          <h4>{{ slot.display_time }}</h4>
          <span>Expired</span>
        </div>

      {% else %}
        <div class="slot available"
             data-hour="{{ slot.time.hour }}"
             data-id="{{ slot.id }}"
             data-price="{{ slot.price }}"
             onclick="toggleSelect(this)">
          <h4>{{ slot.display_time }}</h4>
          <span>₹{{ slot.price }}</span>
        </div>
      {% endif %}

    {% endfor %}
  </div>
</div>

<!-- BOTTOM BAR -->
<div class="booking-bar">
  <span>
    <strong id="count">0</strong> slot(s) selected |
    ₹<span id="total">0</span>
  </span>
  <button id="proceedBtn" disabled onclick="submitBooking()">Proceed</button>
</div>

<form id="bookingForm" method="POST" action="{% url 'user_details' %}">
  {% csrf_token %}
</form>

<script>
let selectedSlots = new Map();

function toggleSelect(el) {
  if (el.classList.contains("booked") || el.classList.contains("expired")) return;

  const slotId = el.dataset.id;
  const price = parseInt(el.dataset.price);

  if (el.classList.contains("selected")) {
    el.classList.remove("selected");
    selectedSlots.delete(slotId);
  } else {
    el.classList.add("selected");
    selectedSlots.set(slotId, price);
  }
  updateSummary();
}

function updateSummary() {
  let total = 0;
  selectedSlots.forEach(v => total += v);

  document.getElementById("count").innerText = selectedSlots.size;
  document.getElementById("total").innerText = total;
  document.getElementById("proceedBtn").disabled = selectedSlots.size === 0;
}

function filterSlots(type, btn) {
  document.querySelectorAll(".filter").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");

  document.querySelectorAll(".slot").forEach(slot => {
    const hour = parseInt(slot.dataset.hour);
    slot.style.display = "block";

    if (type === "morning" && hour >= 12) slot.style.display = "none";
    if (type === "afternoon" && (hour < 12 || hour >= 17)) slot.style.display = "none";
    if (type === "evening" && hour < 17) slot.style.display = "none";
  });
}

function submitBooking() {
  const form = document.getElementById("bookingForm");
  form.querySelectorAll("input[name='slots[]']").forEach(i => i.remove());

  selectedSlots.forEach((_, id) => {
    const input = document.createElement("input");
    input.type = "hidden";
    input.name = "slots[]";
    input.value = id;
    form.appendChild(input);
  });

  form.submit();
}
</script>

{% endblock %}
